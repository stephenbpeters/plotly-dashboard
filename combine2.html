<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" path1tent="width=device-width,  
        initial-scale=1.0" />
    <title>Bellybutton Biodiversity</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div class="container"></div>
    <div class="row">
        <div class="col-md-12 jumbotron text-center">
            <h1>Belly Button Biodiversity Dashboard</h1>
            <p>Use the interactive charts below to explore the dataset</p>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2" style="margin-left: 25px;">
            <div class="well">
                <div id="dropme">
                    <h5>Test Subject ID No.:</h5>
                    <select id="selectMe" onchange="grabData()">
                    </select>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">Demographic Info</h3>

                </div>
                <div id="sample-metadata" class="panel-body">
                    <ul></ul>
                </div>
            </div>
        </div>
        <div class="col-md-8" style="margin-left: 25px;">
            <div id="barDiv"></div>
        </div>
        <div class="col-md-2">
            <div id="gauge"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12" style="margin-left: 25px;">
    <div id="superBubble"></div>
    <!-- <div id="bubbleDiv">HARD CODED BUBBLE DIV</div>  -->
</div>
</div>    
</div>

    <script>

        // point ourselves to our json data file
        var url = "./samples.json";
        console.log('hello start');

        // build and populate our drop-down with our individuals
        function buildDrop() {
            d3.json(url, function (data) {
                // console.log(data);

                // build drop down from data
                d3.select('select')
                    .selectAll('option')
                    .data(data.names)
                    .enter()
                    .append('option')
                    .text(function (d) { return d; });
                // end of dropdown	 
            });
            console.log('dropdown built');
        };

        function buildDemo(selected) {
            d3.json(url, function (data) {
                // console.log(data);

                // build meta data demo window from data
                // let's not forget to filter to what we want to show
                var meta = data.metadata;
                var filteredMeta = meta.filter(patient => patient.id == selected)[0];
                // console.log('our persons meta/demo data is = ', filteredMeta);
                // we have our one person


                var metaList = ['ID: ' + filteredMeta.id, 'AGE: ' + filteredMeta.age,
                'BBTYPE: ' + filteredMeta.bbtype, 'ETHNICITY: ' + filteredMeta.ethnicity,
                'GENDER: ' + filteredMeta.gender, 'LOCATION: ' + filteredMeta.location,
                'WFREQ: ' + filteredMeta.wfreq
                ];

                d3.select("ul")
                    .selectAll("li")
                    .data(metaList)
                    .enter()
                    .append("li")
                    .html(function (d) {
                        return `<td>${d}</td><td>`;
                    });
            });
            // console.log('demo area built');
        }
        buildDemo(940);

        // our event handler to grab our individual to plot
        function grabData() {
            var dropdownMenu2 = d3.select("#selectMe");
            // Assign the value of the dropdown menu option to a variable
            var dropVal = dropdownMenu2.property("value");
            // console.log('our dropVal = ', dropVal);
            // run and build our plot
            // send dropVal to buildPlot and buildmeta
            buildPlot(dropVal);
            // this shows us getting the value of the dropdown
            // now to select our data by that value and show in the console
        }

        buildDrop();

        function buildPlot(ourSelection) {
            d3.json(url, function (data) {
                // console.log('buildplot data load here ', data);
                // console.log('ourSelection (string) = ', ourSelection);
                // var theChosen = parseInt(ourSelection);
                // console.log('the chosen one (integer) = ', theChosen);
                // let's get just our sample stuff
                var samples = data.samples;
                // now we filter for our chosen individual, and we want the first (and only) array in that
                var filteredData = samples.filter(patient => patient.id == ourSelection)[0];
                // console.log('and like magic, our person data is = ', filteredData);
                var otuIDs = filteredData.otu_ids;
                var otuLabels = filteredData.otu_labels;
                var sampleValues = filteredData.sample_values;
                var coolNewlist = [];
                // console.log('foo ', samples);
                // console.log('otuIDs = ', otuIDs);
                // console.log('otuLabels = ', otuLabels);
                // console.log('sampleValues = ', sampleValues);
                // associating our ID's with our sample values
                for (let i = 0; i < otuIDs.length; i++) {
                    coolNewlist.push({
                        "otuID": otuIDs[i],
                        "otuLabel": otuLabels[i],
                        "sampleValue": sampleValues[i]
                    });
                };
                // console.log('coolNewlist =  ', coolNewlist);
                // now to sort by sample value
                // ex; https://stackoverflow.com/questions/8837454/sort-array-of-objects-by-single-key-with-date-value
                coolNewlist.sort(function (a, b) {
                    var keyA = a.sampleValue,
                        keyB = b.sampleValue;
                    // Compare the 2 dates
                    if (keyA < keyB) return -1;
                    if (keyA > keyB) return 1;
                    return 0;
                });
                // now we have our list sorted, printed in reverse below, slice out the 10
                // console.log("our sorted cool new list = ",coolNewlist.reverse().slice(0,10));
                // console.log("our sorted cool new list = ", coolNewlist);
                // looks like we may need to put this into a new list for it to work
                // var sliceList = coolNewlist.reverse().slice(0,10);
                var sortList = coolNewlist.reverse();
                // console.log("sortList = ", sortList);
                var sliceList = sortList.slice(0, 10);
                // console.log("sliceList = ", sliceList);
                // can we get directly to the proper sort & slice?
                // nope, the following two lines do not sort 'n' slice properly
                // var sliced2list =  coolNewlist.reverse().slice(0,10);
                // console.log("sliced2list = ", sliced2list);

                // ok, now we get our properly sorted data into our things to plot
                var ourX = [];
                var ourY = [];
                var ourLabels = [];
                sliceList.forEach((value) => {
                    ourX.push(value.sampleValue);
                    // ourY.push(value.otuID);
                    // oops, this should be a string, maybe
                    ourY.push(value.otuID);
                    ourLabels.push(value.otuLabel.toString());
                });
                // console.log("ourX = ", ourX);
                // console.log("ourY = ", ourY);
                // console.log("ourLabels = ", ourLabels);

                var plotData = [{
                    x: ourX,
                    y: ourLabels,
                    type: 'bar',
                    orientation: 'h'
                }];

                Plotly.newPlot('barDiv', plotData);

                // time for a new bubble plot that takes the indicated sample
                // we'll need to plug in the right data
                // previous data
                // var info = data.samples[0];
                // console.log("show info = data.samples[0] gets first sample id = 940");
                // console.log(info);
                // var info3 = data.samples[0].otu_ids;
                // console.log('otu_ids in first item of data.samples info3 = ');
                // console.log(info3);
                // var info5 = data.samples[0].sample_values;
                // console.log('sample_values in first item of data.samples info5 = ');
                // console.log(info5);
                // var info6 = data.samples[0].otu_labels;
                // console.log('otu_labels in first item of data.samples info6 = ');
                // console.log(info6);
                // 
                var colors = [];
                for (var i = 0; i < 80; i++) {
                    //			colors[i] = (i + 1000 +(i*300));
                    colors[i] = Math.floor(Math.random() * 254)
                }
                console.log("and our colors are: ", colors);
                // draw the bubble chart
                var trace1 = {
                    x: ourX,
                    y: ourY,
                    text: ourLabels,
                    mode: 'markers',
                    marker: {
                        // size: info5,
                        size: ourX,
                        color: colors
                    }
                };

                var dataB = [trace1];

                var layoutB = {
                    title: 'Bubble Chart',
                    showlegend: false,
                    height: 600,
                    width: 1200
                };

                Plotly.newPlot('superBubble', dataB, layoutB);


            });
            console.log('data loaded');
        };
        buildPlot(940);
        // =============================================================
        // this is the working code that gets a hard-coded sample and
        // makes a bubble chart in bubble div
        function buildBubble() {
            d3.json(url, function (data) {
                // console.log(data);
                // get values
                var dropVal = grabData();
                // console.log('our dropval is now = ', dropVal);
                var info = data.samples[0];
                // console.log("show info = data.samples[0] gets first sample id = 940");
                // console.log(info);

                var info3 = data.samples[0].otu_ids;
                // console.log('otu_ids in first item of data.samples info3 = ');
                // console.log(info3);
                var info5 = data.samples[0].sample_values;
                // console.log('sample_values in first item of data.samples info5 = ');
                // console.log(info5);
                var info6 = data.samples[0].otu_labels;
                // console.log('otu_labels in first item of data.samples info6 = ');
                // console.log(info6);
                // sort the sample_values descending and slice out the top 10
                var sortedInfo5 = info5;
                sortedInfo5.sort(function compareFunction(firstNum, secondNum) {
                    return secondNum - firstNum;
                });
                // console.log('here is our sorted data', sortedInfo5);
                var slicedInfo5 = sortedInfo5.slice(0, 10);
                // console.log('here is our sliced data', slicedInfo5);

                // // well, can we make the dropdown do a thing?
                // var fruits = ['apple', 'mango', 'banana', 'orange'];
                // d3.select('select')
                //     .selectAll('option')
                //     .data(slicedInfo5)
                //     .enter()
                //     .append('option')
                //     .text(function (d) { return d; });
                // // end of dropdown	    

                // now we must sort the other two things by same index as the first to get the
                // matching data

                // build the bar chart
                var plotData = [{
                    x: info3,
                    y: slicedInfo5,
                    type: 'bar',
                    orientation: 'h'
                }];
                // turn off the plot
                // Plotly.newPlot('barDiv', plotData);

                // bubble chart plot time
                // hover labels and colors not working right
                // let's see if we can make a colors array from https://www.codecademy.com/forum_questions/50c207bd55df51ff27004775
                var colors = [];
                for (var i = 0; i < 80; i++) {
                    //			colors[i] = (i + 1000 +(i*300));
                    colors[i] = Math.floor(Math.random() * 254)
                }
                // console.log(colors);
                // draw bubble chart
                var trace1 = {
                    x: info3,
                    y: info5,
                    text: info6,
                    mode: 'markers',
                    marker: {
                        size: info5,
                        color: colors
                    }
                };

                var dataB = [trace1];

                var layoutB = {
                    title: 'Bubble Chart',
                    showlegend: false,
                    height: 600,
                    width: 1200
                };
                // turn off the hard-coded bubble plot for now    
                // Plotly.newPlot('bubbleDiv', dataB, layoutB);

            });
            console.log('we are here');
            // console.log("check if we got dropVal: ", dropVal);
        };
        buildBubble();




    </script>
</body>

</html>